https://gitlab.gnome.org/GNOME/epiphany/-/merge_requests/506
https://gitlab.gnome.org/GNOME/epiphany/-/merge_requests/623

Add javascript source code highlighter


diff --git a/embed/ephy-view-source-handler.c b/embed/ephy-view-source-handler.c
index d10867a076e6f68f196f75c292df3fd1e5c7b338..761cf95f0806eb2f40ecb23ab6ae3637c56416a1 100644
--- a/embed/ephy-view-source-handler.c	2019-09-07 16:00:18.000000000 +0000
+++ b/embed/ephy-view-source-handler.c	2020-05-13 14:48:34.165904702 +0000
@@ -108,37 +108,37 @@
                       GAsyncResult          *result,
                       EphyViewSourceRequest *request)
 {
-  guchar *data;
-  char *data_str;
-  char *escaped_str;
-  char *html;
+  g_autofree guchar *data = NULL;
+  g_autofree char *data_str = NULL;
+  g_autofree char *escaped_str = NULL;
+  g_autoptr (GError) error = NULL;
+  g_autofree char *html = NULL;
   gsize length;
-  GError *error = NULL;
 
   data = webkit_web_resource_get_data_finish (resource, result, &length, &error);
   if (error) {
     finish_uri_scheme_request (request, NULL, error);
-    g_error_free (error);
     return;
   }
 
   data_str = g_malloc (length + 1);
   strncpy (data_str, (const char *)data, length);
   data_str[length] = '\0';
-  g_free (data);
 
   escaped_str = g_markup_escape_text (data_str, -1);
-  g_free (data_str);
-
-  html = g_strdup_printf ("<body>"
-                            "<pre>"
-                              "<code class=\"language-html\">%s</code>"
-                            "</pre>"
+  html = g_strdup_printf ("<head>"
+                          "  <link rel='stylesheet' href='ephy-resource:///org/gnome/epiphany/highlightjs/default.css'>"
+                          "</head>"
+                          "<body class='hljs'>"
+                          "  <script src='ephy-resource:///org/gnome/epiphany/highlightjs/highlight.js'></script>"
+                          "  <script src='ephy-resource:///org/gnome/epiphany/highlightjs/highlightjs-line-numbers.js'></script>"
+                          "  <script>hljs.initHighlightingOnLoad();"
+                          "          hljs.initLineNumbersOnLoad();</script>"
+                          "  <pre><code class='html'>%s</code></pre>"
                           "</body>",
                           escaped_str);
-  g_free (escaped_str);
 
-  finish_uri_scheme_request (request, html, NULL);
+  finish_uri_scheme_request (request, g_steal_pointer (&html), NULL);
 }
 
 static void
--- a/src/meson.build
+++ b/src/meson.build
@@ -131,7 +131,8 @@ resources = gnome.compile_resources('epiphany-resources',
 epiphany_sources = [
   'ephy-main.c',
   resources,
-  pdfjs_resources
+  pdfjs_resources,
+  highlightjs_resources
 ]
 
 executable('epiphany',
diff --git a/third-party/highlightjs/README.epiphany b/third-party/highlightjs/README.epiphany
new file mode 100644
index 0000000000000000000000000000000000000000..f8a32dd4b51dd05578953d6f9b21f5a03ce3773c
--- /dev/null
+++ b/third-party/highlightjs/README.epiphany
@@ -0,0 +1,26 @@
+# Embedded source code highlighter based on hightlight.js
+
+This directory contains an official highlight.js release version, distributed at: https://github.com/highlightjs/highlight.js
+
+## Update process
+
+git clone https://github.com/highlightjs/highlight.js.git
+cd highlight.js
+git checkout <version number>
+npm install
+node tools/build.js -n css javascript xml
+
+Copy build/highlight.js to <epiphany-source>/third-party/highlightjs/
+Copy src/styles/default.css to <epiphany-source>third-party/highlightjs/
+
+# Highlight.js line numbers plugin:
+
+git clone https://github.com/wcoder/highlightjs-line-numbers.js.git
+cd highlightjs-line-numbers.js
+
+Copy src/highlightjs-line-numbers.js to <epiphany-source>/third-party/highlightjs/
+
+Append <epiphany-source>/third-party/highlightjs/epiphany.css to
+	<epiphany-source>/third-party/highlightjs/default.css
+
+# Documentation created by Jan-Michael Brummer <jan.brummer@tabos.org>
--- /dev/null	2020-05-20 14:42:37.000000000 +0000
+++ b/third-party/highlightjs/epiphany.css	2020-05-20 14:35:13.660009597 +0000
@@ -0,0 +1,39 @@
+/**
+  * Customizations for GNOME Web
+  *
+  * Append this file to the upstream default.css
+  */
+
+.hljs {
+  /*
+   * fix overflow handling
+   *
+   * let the browser window display overflow scrollbars, if any,
+   * instead of placing scrollbars inside the content
+   */
+  overflow-x: visible !important;
+}
+
+
+/**
+  * styling for the highlightjs-line-numbers plugin
+  */
+.hljs-ln {
+  white-space: pre;
+}
+
+.hljs-ln-numbers {
+  -webkit-touch-callout: none;
+  -webkit-user-select: none;
+  user-select: none;
+
+  text-align: right;
+  color: #ccc;
+  vertical-align: top;
+  border-right: 1px solid;
+  padding-right: 5px !important;
+}
+
+.hljs-ln-code {
+  padding-left: 10px !important;
+}
diff --git a/third-party/highlightjs/highlightjs.gresource.xml b/third-party/highlightjs/highlightjs.gresource.xml
new file mode 100644
index 0000000000000000000000000000000000000000..458aa66042e4c6aef5091cd6f1345b5f7eba0513
--- /dev/null
+++ b/third-party/highlightjs/highlightjs.gresource.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<gresources>
+  <gresource prefix="/org/gnome/epiphany/highlightjs">
+    <file compressed="true">highlight.js</file>
+    <file compressed="true">highlightjs-line-numbers.js</file>
+    <file compressed="true">default.css</file>
+  </gresource>
+</gresources>
diff --git a/third-party/meson.build b/third-party/meson.build
index c09000a47d0d51ae6c80ae4b86f7430ddda248b9..72027a07fcbc121f1878244da2ce46e744097242 100644
--- a/third-party/meson.build
+++ b/third-party/meson.build
@@ -4,3 +4,10 @@
     c_name: 'pdfjs',
     source_dir: 'pdfjs'
 )
+
+highlightjs_resource_files = files('highlightjs/highlightjs.gresource.xml')
+highlightjs_resources = gnome.compile_resources('highlightjs-resources',
+    highlightjs_resource_files,
+    c_name: 'highlightjs',
+    source_dir: 'highlightjs'
+)
--- /dev/null	2020-05-13 19:01:29.000000000 +0000
+++ b/third-party/highlightjs/default.css	2020-05-13 19:04:22.642280165 +0000
@@ -0,0 +1,147 @@
+/**
+ * nnfx - a theme inspired by Netscape Navigator/Firefox
+ *
+ * @version 1.0.0
+ * @author (c) 2020 Jim Mason <jmason@ibinx.com>
+ * @license https://creativecommons.org/licenses/by-sa/4.0  CC BY-SA 4.0
+ */
+
+.hljs {
+  display: block;
+  overflow-x: auto;
+  padding: 0.5em;
+  background: #fff;
+  color: #000;
+}
+
+.xml .hljs-meta {
+  font-weight: bold;
+  font-style: italic;
+  color: #48b;
+}
+
+.hljs-comment,
+.hljs-quote {
+  font-style: italic;
+  color: #070;
+}
+
+.hljs-name,
+.hljs-keyword {
+  color: #808;
+}
+
+.hljs-name,
+.hljs-attr {
+  font-weight: bold;
+}
+
+.hljs-string {
+  font-weight: normal;
+}
+
+.hljs-variable,
+.hljs-template-variable {
+  color: #477;
+}
+
+.hljs-code,
+.hljs-string,
+.hljs-meta-string,
+.hljs-number,
+.hljs-regexp,
+.hljs-link {
+  color: #00f;
+}
+
+.hljs-title,
+.hljs-symbol,
+.hljs-bullet,
+.hljs-built_in,
+.hljs-builtin-name {
+  color: #f40;
+}
+
+.hljs-section,
+.hljs-meta {
+  color: #642;
+}
+
+.hljs-class .hljs-title,
+.hljs-type {
+  color: #639;
+}
+
+.hljs-function .hljs-title,
+.hljs-attr,
+.hljs-subst {
+  color: #000;
+}
+
+.hljs-formula {
+  background-color: #eee;
+  font-style: italic;
+}
+
+.hljs-addition {
+  background-color: #beb;
+}
+
+.hljs-deletion {
+  background-color: #fbb;
+}
+
+.hljs-selector-id,
+.hljs-selector-class {
+  color: #964;
+}
+
+.hljs-doctag,
+.hljs-strong {
+  font-weight: bold;
+}
+
+.hljs-emphasis {
+  font-style: italic;
+}
+
+/**
+  * Customizations for GNOME Web
+  *
+  * Append this file to the upstream default.css
+  */
+
+.hljs {
+  /*
+   * fix overflow handling
+   *
+   * let the browser window display overflow scrollbars, if any,
+   * instead of placing scrollbars inside the content
+   */
+  overflow-x: visible !important;
+}
+
+
+/**
+ * styling for the highlightjs-line-numbers plugin
+ */
+
+.hljs-ln {
+  white-space: pre;
+}
+
+.hljs-ln-numbers {
+  -webkit-touch-callout: none;
+  -webkit-user-select: none;
+  user-select: none;
+
+  text-align: right;
+  color: #ccc;
+  vertical-align: top;
+  border-right: 1px solid;
+  padding-right: 5px !important;
+}
+
+.hljs-ln-code {
+  padding-left: 10px !important;
+}
